<div class="kds-shell">

    <header class="kds-header">
        <div class="kds-brand">
            <lucide-icon name="flame" [size]="28" class="kds-brand-icon"></lucide-icon>
            <div>
                <h1 class="kds-title">Cocina</h1>
                <p class="kds-subtitle">Comandas activas en tiempo real</p>
            </div>
        </div>
        <div class="kds-status">
            <div class="kds-clock">
                <lucide-icon name="clock" [size]="15"></lucide-icon>
                <span>{{ horaActual }}</span>
            </div>
            <ng-container *ngIf="pedidosActivos$ | async as pedidos">
                <div class="kds-badge-count">
                    <span class="count-num">{{ pedidos.length }}</span>
                    <span class="count-label">comandas</span>
                </div>
            </ng-container>
        </div>
    </header>

    <div class="kds-lona"></div>

    <div class="kds-body">
        <ng-container *ngIf="pedidosActivos$ | async as pedidos; else loadingTpl">

            <div class="kds-empty" *ngIf="pedidos.length === 0">
                <lucide-icon name="check-circle" [size]="52"></lucide-icon>
                <p>Sin comandas pendientes</p>
                <span>La cocina esta al dia</span>
            </div>

            <div class="kds-grid">
                <div *ngFor="let pedido of pedidos; trackBy: trackById" class="comanda-card"
                    [ngClass]="claseUrgencia(pedido.timestamp)">

                    <div class="urgencia-bar"></div>

                    <div class="comanda-head">
                        <div class="mesa-num">
                            <lucide-icon name="hash" [size]="14"></lucide-icon>
                            Mesa {{ pedido.mesa_id }}
                        </div>
                        <div class="comanda-chips">
                            <span class="time-chip">
                                <lucide-icon name="clock" [size]="12"></lucide-icon>
                                {{ tiempoEspera(pedido.timestamp) }}
                            </span>
                            <span class="estado-chip" [ngClass]="pedido.estado">
                                {{ pedido.estado | titlecase }}
                            </span>
                        </div>
                    </div>

                    <ul class="items-list">
                        <li *ngFor="let item of pedido.items" class="item-row">
                            <span class="item-qty">{{ item.cantidad }}x</span>
                            <div class="item-body">
                                <span class="item-nombre">{{ item.nombre }}</span>
                                <ul class="mods" *ngIf="item.modificadores_aplicados.length">
                                    <li *ngFor="let m of item.modificadores_aplicados">
                                        <lucide-icon name="chevron-right" [size]="10"></lucide-icon>
                                        {{ m.nombre }}
                                    </li>
                                </ul>
                                <p class="item-nota" *ngIf="item.especificaciones">
                                    <lucide-icon name="clipboard-list" [size]="11"></lucide-icon>
                                    {{ item.especificaciones }}
                                </p>
                            </div>
                        </li>
                    </ul>

                    <button class="btn-avanzar" [ngClass]="pedido.estado" (click)="avanzarEstado(pedido)"
                        [disabled]="pedido.estado === 'listo'">
                        <lucide-icon
                            [name]="pedido.estado === 'pendiente' ? 'flame' : (pedido.estado === 'en_preparacion' ? 'check-circle' : 'circle')"
                            [size]="17"></lucide-icon>
                        <span *ngIf="pedido.estado === 'pendiente'">Iniciar preparacion</span>
                        <span *ngIf="pedido.estado === 'en_preparacion'">Marcar como listo</span>
                        <span *ngIf="pedido.estado === 'listo'">Listo</span>
                    </button>
                </div>
            </div>
        </ng-container>

        <ng-template #loadingTpl>
            <div class="kds-loading">
                <lucide-icon name="refresh-cw" [size]="36" class="spin"></lucide-icon>
                <p>Conectando con cocina...</p>
            </div>
        </ng-template>
    </div>
</div>