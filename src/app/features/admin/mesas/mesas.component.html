<div class="mesas-page" *ngIf="mesas$ | async as mesas">
    <!-- Header -->
    <div class="page-header">
        <h2 class="page-title">Gesti√≥n de Mesas</h2>
        <div class="contadores" *ngIf="actualizarContadores(mesas)">
            <span class="cont ocupadas">üîµ {{ contadores.ocupadas }} ocupadas</span>
            <span class="cont libres">üü¢ {{ contadores.libres }} libres</span>
            <span class="cont sucias">üü° {{ contadores.sucias }} sucias</span>
        </div>
    </div>

    <div class="layout" [class.panel-abierto]="mesaSeleccionada">
        <!-- Grid de mesas -->
        <div class="mesas-grid">
            <div *ngFor="let mesa of mesas; trackBy: trackById" class="mesa-card" [ngClass]="claseMesa(mesa.estado)"
                [class.selected]="mesaSeleccionada?.id === mesa.id" (click)="seleccionarMesa(mesa)">
                <span class="mesa-numero">Mesa {{ mesa.numero }}</span>
                <span class="mesa-badge" [ngClass]="'badge-' + mesa.estado">
                    {{ labelEstado(mesa.estado) }}
                </span>
            </div>

            <div *ngIf="mesas.length === 0" class="empty-state">
                <p>No hay mesas registradas.</p>
            </div>
        </div>

        <!-- Panel de detalle -->
        <aside class="detail-panel" *ngIf="mesaSeleccionada">
            <div class="panel-header">
                <h3>Mesa {{ mesaSeleccionada.numero }}</h3>
                <button class="btn-close" (click)="cerrarPanel()">‚úï</button>
            </div>

            <div class="panel-estado">
                <span class="estado-label">Estado:</span>
                <span class="mesa-badge large" [ngClass]="'badge-' + mesaSeleccionada.estado">
                    {{ labelEstado(mesaSeleccionada.estado) }}
                </span>
            </div>

            <!-- Mesa sucia ‚Üí bot√≥n limpiar -->
            <button *ngIf="mesaSeleccionada.estado === 'sucia'" class="btn-accion btn-limpiar"
                (click)="cambiarEstado(mesaSeleccionada.id, 'libre')">
                üßπ Marcar como Libre
            </button>

            <!-- Mesa libre -->
            <div *ngIf="mesaSeleccionada.estado === 'libre'" class="panel-info-msg">
                <span class="info-icon">‚úÖ</span>
                <p>Mesa disponible para nuevos pedidos.</p>
            </div>

            <!-- Mesa ocupada ‚Üí pedido activo -->
            <div *ngIf="mesaSeleccionada.estado === 'ocupada'">
                <div *ngIf="cargandoPedido" class="panel-loading">
                    <div class="spinner"></div>
                    <span>Cargando pedido...</span>
                </div>

                <div *ngIf="!cargandoPedido && pedidoActivo" class="pedido-detail">
                    <div class="pedido-meta">
                        <span class="meta-item">
                            <span class="meta-label">Pedido</span>
                            <span class="meta-value">{{ pedidoActivo.id | slice:0:8 }}...</span>
                        </span>
                        <span class="meta-item">
                            <span class="meta-label">Tiempo</span>
                            <span class="meta-value">‚è± {{ tiempoDesde(pedidoActivo.timestamp) }}</span>
                        </span>
                        <span class="meta-item">
                            <span class="meta-label">√çtems</span>
                            <span class="meta-value">{{ pedidoActivo.items.length }}</span>
                        </span>
                    </div>

                    <div class="items-section">
                        <h4>Detalle del Pedido</h4>
                        <ul class="item-list">
                            <li *ngFor="let item of pedidoActivo.items" class="item-row">
                                <div class="item-info">
                                    <span class="item-qty">{{ item.cantidad }}√ó</span>
                                    <span class="item-name">{{ item.nombre }}</span>
                                </div>
                                <span class="item-price">${{ (item.precio_snapshot * item.cantidad).toFixed(2) }}</span>
                            </li>
                        </ul>
                    </div>

                    <div class="pedido-totals">
                        <div class="total-row">
                            <span>Subtotal</span>
                            <span>${{ pedidoActivo.subtotal.toFixed(2) }}</span>
                        </div>
                        <div class="total-row" *ngIf="pedidoActivo.descuento_aplicado">
                            <span>Descuento</span>
                            <span class="descuento">-${{ pedidoActivo.descuento_aplicado.monto_descontado.toFixed(2)
                                }}</span>
                        </div>
                        <div class="total-row total-final">
                            <span>Total</span>
                            <span>${{ pedidoActivo.total.toFixed(2) }}</span>
                        </div>
                    </div>
                </div>

                <div *ngIf="!cargandoPedido && !pedidoActivo" class="panel-info-msg">
                    <span class="info-icon">‚ö†Ô∏è</span>
                    <p>No se pudo cargar el pedido activo.</p>
                </div>
            </div>
        </aside>
    </div>
</div>