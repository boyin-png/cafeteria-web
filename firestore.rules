rules_version = "2";
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: verificar que el usuario es staff activo
    function perfil() {
      return get(/databases/$(database)/documents/usuarios_staff/$(request.auth.uid)).data;
    }
    function isAuth()   { return request.auth != null; }
    function isStaff()  { return isAuth() && perfil().activo == true; }
    function isAdmin()  { return isStaff() && perfil().rol == "admin"; }
    function isCajero() { return isStaff() && perfil().rol == "cajero"; }
    function isCocina() { return isStaff() && perfil().rol == "cocina"; }

    match /usuarios_staff/{uid} {
      allow read:   if isAuth() && (isAdmin() || request.auth.uid == uid);
      allow write:  if isAdmin();
    }
    match /configuracion_negocio/{id} {
      allow read:  if isStaff();
      allow write: if isAdmin();
    }
    match /categorias/{id} {
      allow read:  if isAuth();
      allow write: if isAdmin();
    }
    match /productos/{id} {
      allow read:  if isAuth();
      allow write: if isAdmin();
    }
    match /modificadores_productos/{id} {
      allow read:  if isAuth();
      allow write: if isAdmin();
    }
    match /mesas/{id} {
      allow read:   if isStaff();
      allow update: if isStaff();
      allow create: if isAdmin();
      allow delete: if false;
    }
    match /pedidos/{id} {
      allow read:   if isStaff();
      allow create: if isAuth();
      allow update: if isStaff();
      allow delete: if false;
    }
    match /descuentos/{id} {
      allow read:  if isStaff();
      allow write: if isAdmin();
    }
    match /inventario/{id} {
      allow read:  if isStaff();
      allow write: if isAdmin();
    }
    match /turnos_caja/{id} {
      allow read:  if isAdmin() || isCajero(); // Permitimos leer los turnos a los cajeros globalmente (el filtro visual en query se encarga de lo suyo)
      allow create: if isCajero() || isAdmin();
      allow update: if isAdmin() || isCajero(); // El cajero necesita poder cerrar su turno
      allow delete: if false;
    }
    match /ventas_historial/{id} {
      allow read:  if isAdmin() || isCajero(); // Permitimos a los cajeros usar reportes.service.ts para las graficas
      allow write: if false; // Solo Cloud Functions escriben aqui
    }
  }
}